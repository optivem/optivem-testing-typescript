name: Acceptance Stage

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:

concurrency:
  group: acceptance-stage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke-test-rc:
    name: Smoke Test RC
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Configure GitHub Packages
        run: |
          echo "@optivem:registry=https://npm.pkg.github.com" > system-test/smoke-test-rc/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" >> system-test/smoke-test-rc/.npmrc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test dependency resolution (GitHub Packages)
        working-directory: system-test/smoke-test-rc
        run: |
          npm install --force --no-cache
          echo "âœ… Successfully resolved RC package from GitHub Packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run acceptance tests (GitHub Packages)
        working-directory: system-test/smoke-test-rc
        run: npm test

      - name: Create acceptance summary
        run: |
          echo "## âœ… Acceptance Stage Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**RC Package Tested:** Latest RC from GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª **Tests Run:**" >> $GITHUB_STEP_SUMMARY
          echo "- RC package resolution from GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke tests against published RC package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… All acceptance tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step:** RC is ready for promotion to release" >> $GITHUB_STEP_SUMMARY

